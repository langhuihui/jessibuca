!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}var r=e(t((function(e){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports.default=e.exports}))),o=t((function(e){function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})),n=e(o),i=t((function(e){var t=o.default;e.exports=function(e,r){if("object"!==t(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var n=o.call(e,r||"default");if("object"!==t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports}));e(i);var u=t((function(e){var t=o.default;e.exports=function(e){var r=i(e,"string");return"symbol"===t(r)?r:String(r)},e.exports.__esModule=!0,e.exports.default=e.exports}));e(u);var c=e(t((function(e){function t(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,u(o.key),o)}}e.exports=function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports.default=e.exports}))),s=t((function(e){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.__esModule=!0,e.exports.default=e.exports})),a=e(s),d=t((function(e){function t(r,o){return e.exports=t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r,o)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}));e(d);var f=e(t((function(e){e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)},e.exports.__esModule=!0,e.exports.default=e.exports}))),p=t((function(e){var t=o.default;e.exports=function(e,r){if(r&&("object"===t(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return s(e)},e.exports.__esModule=!0,e.exports.default=e.exports})),l=e(p),h=t((function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})),v=e(h),y=function(){function e(){r(this,e)}return c(e,[{key:"on",value:function(e,t,r){var o=this.e||(this.e={});return(o[e]||(o[e]=[])).push({fn:t,ctx:r}),this}},{key:"once",value:function(e,t,r){var o=this;function n(){o.off(e,n);for(var i=arguments.length,u=new Array(i),c=0;c<i;c++)u[c]=arguments[c];t.apply(r,u)}return n._=t,this.on(e,n,r)}},{key:"emit",value:function(e){for(var t=((this.e||(this.e={}))[e]||[]).slice(),r=arguments.length,o=new Array(r>1?r-1:0),n=1;n<r;n++)o[n-1]=arguments[n];for(var i=0;i<t.length;i+=1)t[i].fn.apply(t[i].ctx,o);return this}},{key:"off",value:function(e,t){var r=this.e||(this.e={});if(!e)return Object.keys(r).forEach((function(e){delete r[e]})),void delete this.e;var o=r[e],n=[];if(o&&t)for(var i=0,u=o.length;i<u;i+=1)o[i].fn!==t&&o[i].fn._!==t&&n.push(o[i]);return n.length?r[e]=n:delete r[e],this}}]),e}(),b="debug",g="warn",_={debug:!1,debugLevel:g,debugUuid:"",decoder:"jessibuca-pro-mp4-recorder-decoder.js"},m="init",k="startRecord",x="stopRecord",w="videoFrame",R="audioFrame",M="init",A="startRecordError",O="startRecordSuccess",E="recordEnd",W="stopRecordError",j="load",P="workerError",T="startRecordSuccess",N="startRecordError",S="stopRecordError",D="recordEnd";function G(e){return null==e}function F(){return function(e){var t="";if("object"===n(e))try{t=JSON.stringify(e),t=JSON.parse(t)}catch(r){t=e}else t=e;return t}(_)}function J(e){return!0!==e&&"true"!==e}var U=c((function e(t){r(this,e),this.log=function(e){if(t._opt.debug&&t._opt.debugLevel==b){for(var r,o=t._opt.debugUuid?"[".concat(t._opt.debugUuid,"]"):"",n=arguments.length,i=new Array(n>1?n-1:0),u=1;u<n;u++)i[u-1]=arguments[u];(r=console).log.apply(r,["JbPro".concat(o,"[✅✅✅][wasmMp4Recorder][").concat(e,"]")].concat(i))}},this.warn=function(e){if(t._opt.debug&&(t._opt.debugLevel==b||t._opt.debugLevel==g)){for(var r,o=t._opt.debugUuid?"[".concat(t._opt.debugUuid,"]"):"",n=arguments.length,i=new Array(n>1?n-1:0),u=1;u<n;u++)i[u-1]=arguments[u];(r=console).log.apply(r,["JbPro".concat(o,"[❗❗❗][wasmMp4Recorder][").concat(e,"]")].concat(i))}},this.error=function(e){for(var r,o=t._opt.debugUuid?"[".concat(t._opt.debugUuid,"]"):"",n=arguments.length,i=new Array(n>1?n-1:0),u=1;u<n;u++)i[u-1]=arguments[u];(r=console).error.apply(r,["JbPro".concat(o,"[❌❌❌][wasmMp4Recorder][").concat(e,"]")].concat(i))}}));function L(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,o=v(e);if(t){var n=v(this).constructor;r=Reflect.construct(o,arguments,n)}else r=o.apply(this,arguments);return l(this,r)}}var B=function(e){f(o,e);var t=L(o);function o(e){var n;r(this,o),(n=t.call(this)).mp4Recorder=e,n.TAG_NAME="DecoderWorker";var i=e._opt.decoder;return n.decoderWorker=new Worker(i),n._initDecoderWorker(),e.debug.log(n.TAG_NAME,"init"),n}return c(o,[{key:"destroy",value:function(){this.off(),this.decoderWorker&&(this.decoderWorker.terminate(),this.decoderWorker=null),this.mp4Recorder.debug.log(this.TAG_NAME,"destroy")}},{key:"_initDecoderWorker",value:function(){var e=this,t=this.mp4Recorder.debug;this.decoderWorker.onerror=function(t){e.mp4Recorder.debug.error(e.TAG_NAME,"onerror:",t),e.emit(P,t)},this.decoderWorker.onmessageerror=function(t){e.mp4Recorder.debug.error(e.TAG_NAME,"onmessageerror:",t)},this.decoderWorker.onmessage=function(r){var o=r.data;switch(o.cmd){case M:t.log(e.TAG_NAME,"onmessage:",M),e.decoderWorker&&e._initWorker(),e.emit(j);break;case A:e.emit(N);break;case O:e.emit(T);break;case W:e.emit(S);break;case E:e.emit(D,o.data)}}}},{key:"_initWorker",value:function(){var e={debug:this.mp4Recorder._opt.debug,debugLevel:this.mp4Recorder._opt.debugLevel,debugUuid:this.mp4Recorder._opt.debugUuid};this.decoderWorker.postMessage({cmd:m,opt:JSON.stringify(e)})}},{key:"sendVideoFrame",value:function(e,t,r){this.decoderWorker.postMessage({cmd:w,data:e,isIFrame:t,ts:r},[e.buffer])}},{key:"sendAudioFrame",value:function(e,t){this.decoderWorker.postMessage({cmd:R,data:e,ts:t},[e.buffer])}},{key:"startRecord",value:function(e){this.decoderWorker.postMessage({cmd:k,streamInfo:e})}},{key:"stopRecord",value:function(){this.decoderWorker.postMessage({cmd:x})}}]),o}(y);function V(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,o=v(e);if(t){var n=v(this).constructor;r=Reflect.construct(o,arguments,n)}else r=o.apply(this,arguments);return l(this,r)}}var I=function(e){f(o,e);var t=V(o);function o(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,o),(e=t.call(this))._opt={},Object.keys(n).forEach((function(e){if(void 0===n[e])throw new Error('JbProMp4Recorder option "'.concat(e,'" can not be undefined'))})),e.originalOptions=n;var i=F(),u=Object.assign({},i,n);return e._opt=u,e.isRecording=!1,e.debug=new U(a(e)),e.worker=null,e.startTimestamp=null,e.TAG_NAME="Recorder",e.debug.log(e.TAG_NAME,"init",JSON.stringify(e._opt)),e}return c(o,[{key:"destroy",value:function(){this._reset(),this._destroyWorker()}},{key:"_reset",value:function(){this.isRecording=!1}},{key:"_destroyWorker",value:function(){this.worker&&(this.worker.destroy(),this.worker=null)}},{key:"startRecord",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise((function(r,o){e.debug.log(e.TAG_NAME,"startRecord",t);var n=!!t.audio,i=!!t.video;if(J(i)&&J(n))o("video and audio can not be false at the same time");else{if(n){if(G(t.audio.type))return void o("audio type can not be undefined");if(G(t.audio.extraData))return void o("audio extraData can not be undefined");if(G(t.audio.sampleRate))return void o("audio extraData can not be undefined");if(G(t.audio.channels))return void o("audio channels can not be undefined");if(G(t.audio.depth))return void o("audio depth can not be undefined")}if(i){if(G(t.video.type))return void o("video type can not be undefined");if(G(t.video.extraData))return void o("video extraData can not be undefined");if(G(t.video.width))return void o("video width can not be undefined");if(G(t.video.height))return void o("video height can not be undefined")}e.worker?e._startRecord(t,r,o):(e.worker=new B(e),e.worker.once(j,(function(){e._startRecord(t,r,o),e.startTimestamp=Date.now()})),e.worker.once(P,(function(e){o(e)})))}}))}},{key:"_startRecord",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0,o=arguments.length>2?arguments[2]:void 0;this.worker.startRecord(t),this.worker.once(N,(function(e){o(e)})),this.worker.once(T,(function(){e.isRecording=!0,r()}))}},{key:"stopRecord",value:function(){var e=this;return new Promise((function(t,r){e.debug.log(e.TAG_NAME,"stopRecord"),J(e.isRecording)&&(e._destroyWorker(),r("isRecording is false")),e.isRecording=!1,e.worker.stopRecord(),e.worker.once(S,(function(t){e._destroyWorker(),r(t)})),e.worker.once(D,(function(r){e._destroyWorker();var o=new Blob([r.buffer],{type:"video/mp4"});t(o)}))}))}},{key:"sendVideoFrame",value:function(e,t,r){if(this.isRecording&&this.worker){if(Date.now()-this.startTimestamp>6e5)return;this.worker.sendVideoFrame(e,t,r)}}},{key:"sendAudioFrame",value:function(e,t){if(this.isRecording&&this.worker){if(Date.now()-this.startTimestamp>6e5)return;this.worker.sendAudioFrame(e,t)}}}]),o}(y);window.JessibucaProMp4Recorder=I}));
